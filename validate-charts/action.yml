name: 'Validate helm charts'
description: 'prevalidate helm chart template before its deployment; executes helm lint and helm template commands'
inputs:
  chart-path:
    description: 'Path to helm chart directory'
    required: true
    default: './helm'
  extra-args:
    description: 'Arguments to be appended to lint and template commands such as "--set global.env=dev"'
    required: true
    default: ''
runs:
  using: "composite"
  steps:
    - name: validate helm chart
      shell: bash
      run: |
        helm version
        helm dependency update ${{ inputs.chart-path }}
        helm lint ${{ inputs.chart-path }} ${{ inputs.extra-args }}
        helm template ${{ inputs.chart-path }} ${{ inputs.extra-args }}
    - name: ensure no trailing spaces in config maps
      shell: bash --noprofile --norc -e {0} # removing pipefail from default for hacking around grep exit code
      run: |
        configmaps=($(find ${{ inputs.chart-path }} -type f -regex '.*\.ya*ml' -exec grep -l "kind: ConfigMap" {} \;))
        COUNTER=0
        echo "Checking these config maps for trailing spaces:"
        for yaml in "${configmaps[@]}"
        do
            echo $yaml
            (grep -nE '\S\s+$' $yaml && ((COUNTER=COUNTER+1)) && echo "^^^^^^ in file: $yaml" ) || true
        done
        echo "final counter $COUNTER" && test $COUNTER -gt 0 && echo "$COUNTER config map yamls contain trailing spaces, use line numbers to remove them"
        exit 1

        matches=$(grep -c '\S\s+$' ${{ inputs.chart-path }}/values.yaml || true)
        (test $matches -ne 0 && grep -nE '\S\s+$' ${{ inputs.chart-path }}/values.yaml && echo "^^^^^^ values.yaml has trailing spaces, please remove them" && exit 1) || (test $COUNTER -gt 0 && exit 1) || true
